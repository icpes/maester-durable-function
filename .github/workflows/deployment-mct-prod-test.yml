name: Deploy PowerShell Durable Functions to Azure

on:
  push:
    branches:
      - main

env:
  AZURE_FUNCTIONAPP_NAME: 'fu-maester-prod-test'  
  AZURE_FUNCTIONAPP_RG:  'rg-maester-new'   

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'

    # Bundle PowerShell modules to reduce cold-start time
    - name: Prepare PowerShell modules
      shell: pwsh
      run: |
        # Ensure modules directory exists
        if (-not (Test-Path './modules')) {
          New-Item -ItemType Directory -Path './modules' -Force
        }
        # Copy/ensure Maester module is available
        if (Test-Path './modules/Maester') {
          Write-Host "Maester module found"
        }

    # Verify maester-tests exist before packaging
    - name: Verify maester-tests
      shell: pwsh
      run: |
        if (Test-Path './maester-tests') {
          $testCount = (Get-ChildItem -Path './maester-tests' -Recurse -Filter '*.Tests.ps1').Count
          Write-Host "Found $testCount test files"
        } else {
          Write-Error "maester-tests folder not found!"
          exit 1
        }

    # Archive your app including required folders
    - name: Archive function app for deployment
      run: |
        zip -r functionapp.zip . \
          -x '*.git*' \
          '.github/*' \
          'README.md' \
          'create-allfiles.ps1' \
          'profile.ps1' \
          'Install-Maester.ps1' \
          '.vscode/*' \
          'TestResults/*'

    # Login to Azure
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Deploy to Azure Functions
    - name: Deploy to Azure Functions
      uses: azure/functions-action@v1
      with:
        app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
        package: functionapp.zip

    # Update app settings if needed
    - name: Update Azure Function AppSettings
      uses: azure/cli@v2
      with:
        inlineScript: |
          az functionapp config appsettings set \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.AZURE_FUNCTIONAPP_RG }} \
            --settings \
              "ENABLE_MSDEPLOY=true" \
              "SCM_DO_BUILD_DURING_DEPLOYMENT=false"